#
# Patch created from:
# http://archives.free.net.ph/message/20061005.154812.93577927.en.html
#
diff -Nur ccache-2.4/ccache.c ccache/ccache.c
--- ccache-2.4/ccache.c	2004-09-13 07:38:30.000000000 -0300
+++ ccache/ccache.c	2006-10-04 23:12:44.000000000 -0300
@@ -23,6 +23,11 @@
 
 #include "ccache.h"
 
+
+#ifdef HAVE_MACH_O_ARCH_H
+#include <mach-o/arch.h>
+#endif
+
 /* the base cache directory */
 char *cache_dir = NULL;
 
@@ -38,9 +43,6 @@
 /* the original argument list */
 static ARGS *orig_args;
 
-/* the output filename being compiled to */
-static char *output_file;
-
 /* the source file */
 static char *input_file;
 
@@ -65,6 +67,23 @@
 /* can we safely use the unification hashing backend? */
 static int enable_unify;
 
+
+/* A list of requested architectures */
+static ARGS *arches = NULL;
+
+/* Intermediate per-arch output files */
+static ARGS *arch_outs = NULL;
+
+/* Final output file, may be multi-arch */
+static char *final_out = NULL;
+
+/* The output filename being used for the current arch, may be intermediate */
+static char *current_out = NULL;
+
+/* A string to identify the arch in error messages */
+static char *arch_str = NULL;
+
+
 /* a list of supported file extensions, and the equivalent
    extension for code that has been through the pre-processor
 */
@@ -87,12 +106,28 @@
 	{"ii", "ii"},
 	{NULL, NULL}};
 
+/* clean intermediate per-arch output */
+static void clean_arch_outs(void)
+{
+	if (arch_outs) {
+		int i;
+		for (i = 0; i < arch_outs->argc; ++i) {
+			unlink(arch_outs->argv[i]);
+		}
+		/* don't worry about leaking, this function is designed to be called
+		   only just before we die */
+	}
+}
+
+
 /*
   something went badly wrong - just execute the real compiler
 */
 static void failed(void)
 {
 	char *e;
+	
+	clean_arch_outs();
 
 	/* delete intermediate pre-processor file if needed */
 	if (i_tmpfile) {
@@ -128,6 +163,11 @@
 	exit(1);
 }
 
+/* exit, but make sure we clean up first */
+static void safe_exit(int status) {
+	clean_arch_outs();
+	exit(status);
+}
 
 /* return a string to be used to distinguish temporary files 
    this also tries to cope with NFS by adding the local hostname 
@@ -182,7 +222,7 @@
 	args_pop(args, 3);
 
 	if (stat(tmp_stdout, &st1) != 0 || st1.st_size != 0) {
-		cc_log("compiler produced stdout for %s\n", output_file);
+		cc_log("compiler produced stdout for %s%s\n", final_out, arch_str);
 		stats_update(STATS_STDOUT);
 		unlink(tmp_stdout);
 		unlink(tmp_stderr);
@@ -193,13 +233,14 @@
 
 	if (status != 0) {
 		int fd;
-		cc_log("compile of %s gave status = %d\n", output_file, status);
+		cc_log("compile of %s gave status = %d%s\n", final_out, status,
+			arch_str);
 		stats_update(STATS_STATUS);
 
 		fd = open(tmp_stderr, O_RDONLY | O_BINARY);
 		if (fd != -1) {
-			if (strcmp(output_file, "/dev/null") == 0 ||
-			    rename(tmp_hashname, output_file) == 0 || errno == ENOENT) {
+			if (strcmp(current_out, "/dev/null") == 0 ||
+			    rename(tmp_hashname, current_out) == 0 || errno == ENOENT) {
 				if (cpp_stderr) {
 					/* we might have some stderr from cpp */
 					int fd2 = open(cpp_stderr, O_RDONLY | O_BINARY);
@@ -219,7 +260,7 @@
 				if (i_tmpfile && !direct_i_file) {
 					unlink(i_tmpfile);
 				}
-				exit(status);
+				safe_exit(status);
 			}
 		}
 		
@@ -239,7 +280,7 @@
 		failed();
 	}
 
-	cc_log("Placed %s into cache\n", output_file);
+	cc_log("Placed %s into cache%s\n", final_out, arch_str);
 	stats_tocache(file_size(&st1) + file_size(&st2));
 
 	free(tmp_hashname);
@@ -386,7 +427,7 @@
 			unlink(path_stdout);
 		}
 		unlink(path_stderr);
-		cc_log("the preprocessor gave %d\n", status);
+		cc_log("the preprocessor gave %d%s\n", status, arch_str);
 		stats_update(STATS_PREPROCESSOR);
 		failed();
 	}
@@ -447,10 +488,12 @@
 
 
 /* 
-   try to return the compile result from cache. If we can return from
-   cache then this function exits with the correct status code,
-   otherwise it returns */
-static void from_cache(int first)
+   try to return the compile result from cache.
+   
+   If we can use the cached value, does so and returns true.
+   Otherwise returns false.
+*/
+static int from_cache(int first)
 {
 	int fd_stderr, fd_cpp_stderr;
 	char *stderr_file;
@@ -462,7 +505,7 @@
 	if (fd_stderr == -1) {
 		/* it isn't in cache ... */
 		free(stderr_file);
-		return;
+		return 0;
 	}
 
 	/* make sure the output is there too */
@@ -470,7 +513,7 @@
 		close(fd_stderr);
 		unlink(stderr_file);
 		free(stderr_file);
-		return;
+		return 0;
 	}
 
 	/* the user might be disabling cache hits */
@@ -478,44 +521,44 @@
 		close(fd_stderr);
 		unlink(stderr_file);
 		free(stderr_file);
-		return;
+		return 0;
 	}
 
 	utime(stderr_file, NULL);
 
-	if (strcmp(output_file, "/dev/null") == 0) {
+	if (strcmp(current_out, "/dev/null") == 0) {
 		ret = 0;
 	} else {
-		unlink(output_file);
+		unlink(current_out);
 		if (getenv("CCACHE_HARDLINK")) {
-			ret = link(hashname, output_file);
+			ret = link(hashname, current_out);
 		} else {
-			ret = copy_file(hashname, output_file);
+			ret = copy_file(hashname, current_out);
 		}
 	}
 
 	/* the hash file might have been deleted by some external process */
 	if (ret == -1 && errno == ENOENT) {
-		cc_log("hashfile missing for %s\n", output_file);
+		cc_log("hashfile missing for %s\n", current_out);
 		stats_update(STATS_MISSING);
 		close(fd_stderr);
 		unlink(stderr_file);
-		return;
+		return 0;
 	}
 	free(stderr_file);
 
 	if (ret == -1) {
-		ret = copy_file(hashname, output_file);
+		ret = copy_file(hashname, current_out);
 		if (ret == -1) {
 			cc_log("failed to copy %s -> %s (%s)\n", 
-			       hashname, output_file, strerror(errno));
+			       hashname, current_out, strerror(errno));
 			stats_update(STATS_ERROR);
 			failed();
 		}
 	}
 	if (ret == 0) {
 		/* update the mtime on the file so that make doesn't get confused */
-		utime(output_file, NULL);
+		utime(current_out, NULL);
 	}
 
 	/* get rid of the intermediate preprocessor file */
@@ -541,13 +584,13 @@
 	copy_fd(fd_stderr, 2);
 	close(fd_stderr);
 
-	/* and exit with the right status code */
+	/* and return with true */
 	if (first) {
-		cc_log("got cached result for %s\n", output_file);
+		cc_log("got cached result for %s%s\n", final_out, arch_str);
 		stats_update(STATS_CACHED);
 	}
 
-	exit(0);
+	return 1;
 }
 
 /* find the real compiler. We just search the PATH to find a executable of the 
@@ -583,7 +626,7 @@
 	if (!orig_args->argv[0]) {
 		stats_update(STATS_COMPILER);
 		perror(base);
-		exit(1);
+		safe_exit(1);
 	}
 }
 
@@ -616,6 +659,48 @@
 }
 
 
+/* Get the default arch.
+ * By default, uses a heuristic to try to determine the arch that the compiler
+ * will choose in the absence of any -arch options.
+ *
+ * To predetermine the default arch, set the CCACHE_DEFAULT_ARCH env var.
+ * Setting it to the empty string is a good way to disable the use of any
+ * default arch.
+ *
+ * The result is allocated memory, and should be freed after use.
+ */
+static char *default_arch(void)
+{
+	char *arch;
+	
+	if ((arch = getenv("CCACHE_DEFAULT_ARCH"))) {
+		/* it's the user's fault if it breaks, yay! */
+		if (*arch == '\0') {
+			return NULL;	/* empty string -> no default */
+		} else {
+			return x_strdup(arch);
+		}
+	} else {
+#ifdef HAVE_MACH_O_ARCH_H
+		/* Do some darwin mojo */
+		cpu_type_t cpu;
+		const NXArchInfo *local, *general;
+		
+		local = NXGetLocalArchInfo();
+		if (!local) return NULL;
+		
+		/* Darwin doesn't seem to ever default to 64-bit */
+		cpu = local->cputype & ~CPU_ARCH_ABI64;
+		general = NXGetArchInfoFromCpuType(cpu, CPU_SUBTYPE_MULTIPLE);
+		if (!general) return NULL;
+		
+		return x_strdup(general->name);
+#else
+		return NULL;
+#endif
+	}
+}
+
 /* 
    process the compiler options to form the correct set of options 
    for obtaining the preprocessor output
@@ -633,6 +718,30 @@
 	args_add(stripped_args, argv[0]);
 
 	for (i=1; i<argc; i++) {
+		/* make sure we know about all arches, then strip them */
+		if (strcmp(argv[i], "-arch") == 0) {
+			int want = 1;
+			
+			if (!arches) {
+				arches = args_init(0, NULL);
+			} else {
+				/* make sure we don't add an arch twice */
+				int j;
+				for (j = 0; j < arches->argc; ++j) {
+					if (strcmp(arches->argv[j], argv[i+1]) == 0) {
+						want = 0;
+						break;
+					}
+				}
+			}
+			
+			if (want) {
+				args_add(arches, argv[i+1]);
+			}
+			++i;
+			continue;
+		}
+		
 		/* some options will never work ... */
 		if (strcmp(argv[i], "-E") == 0) {
 			failed();
@@ -670,14 +779,14 @@
 				stats_update(STATS_ARGS);
 				failed();
 			}
-			output_file = argv[i+1];
+			final_out = argv[i+1];
 			i++;
 			continue;
 		}
 		
 		/* alternate form of -o, with no space */
 		if (strncmp(argv[i], "-o", 2) == 0) {
-			output_file = &argv[i][2];
+			final_out = &argv[i][2];
 			continue;
 		}
 
@@ -793,20 +902,20 @@
 
 
 	/* don't try to second guess the compilers heuristics for stdout handling */
-	if (output_file && strcmp(output_file, "-") == 0) {
+	if (final_out && strcmp(final_out, "-") == 0) {
 		stats_update(STATS_OUTSTDOUT);
 		failed();
 	}
 
-	if (!output_file) {
+	if (!final_out) {
 		char *p;
-		output_file = x_strdup(input_file);
-		if ((p = strrchr(output_file, '/'))) {
-			output_file = p+1;
+		final_out = x_strdup(input_file);
+		if ((p = strrchr(final_out, '/'))) {
+			final_out = p+1;
 		}
-		p = strrchr(output_file, '.');
+		p = strrchr(final_out, '.');
 		if (!p || !p[1]) {
-			cc_log("badly formed output_file %s\n", output_file);
+			cc_log("badly formed final_out %s\n", final_out);
 			stats_update(STATS_ARGS);
 			failed();
 		}
@@ -815,8 +924,8 @@
 	}
 
 	/* cope with -o /dev/null */
-	if (strcmp(output_file,"/dev/null") != 0 && stat(output_file, &st) == 0 && !S_ISREG(st.st_mode)) {
-		cc_log("Not a regular file %s\n", output_file);
+	if (strcmp(final_out,"/dev/null") != 0 && stat(final_out, &st) == 0 && !S_ISREG(st.st_mode)) {
+		cc_log("Not a regular file %s\n", final_out);
 		stats_update(STATS_DEVICE);
 		failed();
 	}
@@ -825,15 +934,104 @@
 		char *p = find_executable(e, MYNAME);
 		if (!p) {
 			perror(e);
-			exit(1);
+			safe_exit(1);
 		}
 		args_add_prefix(stripped_args, p);
 	}
+	
+	/* if we have just zero or one arch, don't do any multi-arch stuff */
+	if (!arches) {
+		char *dflt;
+		if (( dflt = default_arch() )) {
+			args_add(stripped_args, "-arch");
+			args_add(stripped_args, dflt);
+			free(dflt);
+		}
+	} else if (arches->argc == 1) {
+		args_add(stripped_args, "-arch");
+		args_add(stripped_args, arches->argv[0]);
+		args_pop(arches, 1);
+		free(arches);
+		arches = NULL;
+	}
+}
+
+
+/* set up for a single arch */
+static void setup_arch(int i)
+{
+	if (arches) {
+		/* clean up from the last time we were called */
+		if (current_out) {
+			free(current_out);
+			args_pop(stripped_args, 2);
+			free(arch_str);
+		}
+		
+		/* set up a temporary one-arch output file */
+		x_asprintf(&current_out, "%s/tmp.archout.%s.%s", temp_dir,
+			arches->argv[i], tmp_string());
+		if (!arch_outs) {
+			arch_outs = args_init(0, NULL);
+		}
+		args_add(arch_outs, current_out);
+		
+		/* add the -arch argument for this step */
+		args_add(stripped_args, "-arch");
+		args_add(stripped_args, arches->argv[i]);
+		
+		x_asprintf(&arch_str, " (arch %s)", arches->argv[i]);
+	} else {
+		current_out = final_out;
+		arch_str = "";
+	}
 }
 
+/* merge the arches, if necessary. Exits, does not return! */
+static void merge_arches(void)
+{
+	ARGS *lipo_args;
+	const char *lipo;
+	int i, status;
+	
+	if (!arches) {
+		exit(0); /* we're not needed */
+	}
+	
+	/* clean up from setup_arch */
+	free(current_out);
+	args_pop(stripped_args, 2);
+	free(arch_str);
+	
+	/* find a lipo executable */
+	lipo = find_executable("lipo", "");
+	if (!lipo) {
+		cc_log("can't find lipo");
+		failed();
+	}
+	
+	/* set up args to give to lipo */
+	lipo_args = args_init(0, NULL);
+	args_add(lipo_args, lipo);
+	args_add(lipo_args, "-create");
+	args_add(lipo_args, "-output");
+	args_add(lipo_args, final_out);
+	for (i = 0; i < arch_outs->argc; ++i) {
+		args_add(lipo_args, arch_outs->argv[i]);
+	}
+	
+	/* run it, and exit */
+	unlink(final_out);
+	status = execute(lipo_args->argv, NULL, NULL);
+	safe_exit(status);
+}
+
+
 /* the main ccache driver function */
 static void ccache(int argc, char *argv[])
 {
+	int i;
+	
 	/* find the real compiler */
 	find_compiler(argc, argv);
 	
@@ -850,27 +1048,33 @@
 	/* process argument list, returning a new set of arguments for pre-processing */
 	process_args(orig_args->argc, orig_args->argv);
 
-	/* run with -E to find the hash */
-	find_hash(stripped_args);
-
-	/* if we can return from cache at this point then do */
-	from_cache(1);
-
-	if (getenv("CCACHE_READONLY")) {
-		cc_log("read-only set - doing real compile\n");
+	/* get intermediary files per-arch -- at least once! */
+	for (i = 0; i == 0 || (arches && i < arches->argc); ++i) {
+		setup_arch(i);
+		
+		/* run with -E to find the hash */
+		find_hash(stripped_args);
+		
+		if (from_cache(1)) continue; /* done with this step */
+		
+		if (getenv("CCACHE_READONLY")) {
+			cc_log("read-only set - doing real compile\n");
+			failed();
+		}
+		
+		/* run real compiler, sending output to cache */
+		to_cache(stripped_args);
+	
+		/* return from cache */
+		if (from_cache(0)) continue;
+	
+		/* oh oh! */
+		cc_log("secondary from_cache failed!\n");
+		stats_update(STATS_ERROR);
 		failed();
 	}
 	
-	/* run real compiler, sending output to cache */
-	to_cache(stripped_args);
-
-	/* return from cache */
-	from_cache(0);
-
-	/* oh oh! */
-	cc_log("secondary from_cache failed!\n");
-	stats_update(STATS_ERROR);
-	failed();
+	merge_arches();
 }
 
 
diff -Nur ccache-2.4/configure ccache/configure
--- ccache-2.4/configure	2004-09-13 07:38:30.000000000 -0300
+++ ccache/configure	2007-03-04 22:47:59.000000000 -0300
@@ -936,7 +936,7 @@
     else
       echo "$as_me: WARNING: no configuration information is in $ac_dir" >&2
     fi
-    cd "$ac_popdir"
+    cd $ac_popdir
   done
 fi
 
@@ -1859,7 +1859,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -1917,7 +1918,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -2033,7 +2035,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -2087,7 +2090,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -2132,7 +2136,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -2176,7 +2181,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -2609,7 +2615,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -2681,7 +2688,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -2735,7 +2743,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -2806,7 +2815,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -2860,7 +2870,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -2927,7 +2938,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -2997,7 +3009,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -3078,7 +3091,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -3248,7 +3262,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -3286,7 +3301,8 @@
 
 
 
-for ac_header in ctype.h strings.h stdlib.h string.h pwd.h
+
+for ac_header in ctype.h strings.h stdlib.h string.h pwd.h mach-o/arch.h
 do
 as_ac_Header=`echo "ac_cv_header_$ac_header" | $as_tr_sh`
 if eval "test \"\${$as_ac_Header+set}\" = set"; then
@@ -3319,7 +3335,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -3509,7 +3526,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -3611,7 +3629,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -3676,7 +3695,8 @@
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
+	 { ac_try='test -z "$ac_c_werror_flag"
+			 || test ! -s conftest.err'
   { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -4568,6 +4588,11 @@
   *) ac_INSTALL=$ac_top_builddir$INSTALL ;;
   esac
 
+  if test x"$ac_file" != x-; then
+    { echo "$as_me:$LINENO: creating $ac_file" >&5
+echo "$as_me: creating $ac_file" >&6;}
+    rm -f "$ac_file"
+  fi
   # Let's still pretend it is `configure' which instantiates (i.e., don't
   # use $as_me), people would be surprised to read:
   #    /* config.h.  Generated by config.status.  */
@@ -4606,12 +4631,6 @@
 	 fi;;
       esac
     done` || { (exit 1); exit 1; }
-
-  if test x"$ac_file" != x-; then
-    { echo "$as_me:$LINENO: creating $ac_file" >&5
-echo "$as_me: creating $ac_file" >&6;}
-    rm -f "$ac_file"
-  fi
 _ACEOF
 cat >>$CONFIG_STATUS <<_ACEOF
   sed "$ac_vpsub
diff -Nur ccache-2.4/configure.in ccache/configure.in
--- ccache-2.4/configure.in	2004-09-13 07:38:30.000000000 -0300
+++ ccache/configure.in	2006-10-04 22:22:26.000000000 -0300
@@ -27,7 +27,7 @@
 AC_HEADER_TIME
 AC_HEADER_SYS_WAIT
 
-AC_CHECK_HEADERS(ctype.h strings.h stdlib.h string.h pwd.h)
+AC_CHECK_HEADERS(ctype.h strings.h stdlib.h string.h pwd.h mach-o/arch.h)
 
 AC_CHECK_FUNCS(realpath snprintf vsnprintf vasprintf asprintf mkstemp)
 AC_CHECK_FUNCS(gethostname getpwuid)
diff -Nur ccache-2.4/execute.c ccache/execute.c
--- ccache-2.4/execute.c	2004-09-13 07:38:30.000000000 -0300
+++ ccache/execute.c	2006-10-04 13:23:27.000000000 -0300
@@ -35,22 +35,28 @@
 	
 	if (pid == 0) {
 		int fd;
-
-		unlink(path_stdout);
-		fd = open(path_stdout, O_WRONLY|O_CREAT|O_TRUNC|O_EXCL|O_BINARY, 0666);
-		if (fd == -1) {
-			exit(STATUS_NOCACHE);
+		
+		if (path_stdout) {
+			unlink(path_stdout);
+			fd = open(path_stdout, O_WRONLY|O_CREAT|O_TRUNC|O_EXCL|O_BINARY,
+				0666);
+			if (fd == -1) {
+				exit(STATUS_NOCACHE);
+			}
+			dup2(fd, 1);
+			close(fd);
 		}
-		dup2(fd, 1);
-		close(fd);
 
-		unlink(path_stderr);
-		fd = open(path_stderr, O_WRONLY|O_CREAT|O_TRUNC|O_EXCL|O_BINARY, 0666);
-		if (fd == -1) {
-			exit(STATUS_NOCACHE);
+		if (path_stderr) {
+			unlink(path_stderr);
+			fd = open(path_stderr, O_WRONLY|O_CREAT|O_TRUNC|O_EXCL|O_BINARY,
+				0666);
+			if (fd == -1) {
+				exit(STATUS_NOCACHE);
+			}
+			dup2(fd, 2);
+			close(fd);
 		}
-		dup2(fd, 2);
-		close(fd);
 
 		exit(execv(argv[0], argv));
 	}
